<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>QuickDesk | Ticket Details</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --primary-light: #4895ef;
      --secondary: #3f37c9;
      --error: #ef233c;
      --success: #4cc9f0;
    }
    
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f8fafc;
    }
    
    .sidebar {
      background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      color: white;
      box-shadow: 4px 0 10px rgba(0, 0, 0, 0.1);
    }
    
    .nav-link {
      transition: all 0.2s ease;
    }
    
    .nav-link:hover {
      background: rgba(255, 255, 255, 0.1);
    }
    
    .ticket-card {
      background: white;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }
    
    .badge {
      font-size: 0.75rem;
      padding: 0.25rem 0.75rem;
      border-radius: 9999px;
      font-weight: 500;
    }
    
    .badge-open {
      background: #dbeafe;
      color: #2563eb;
    }
    
    .badge-closed {
      background: #dcfce7;
      color: #16a34a;
    }
    
    .badge-pending {
      background: #fef9c3;
      color: #ca8a04;
    }
    
    .badge-high {
      background: #fee2e2;
      color: #dc2626;
    }
    
    .badge-medium {
      background: #fef3c7;
      color: #d97706;
    }
    
    .badge-low {
      background: #e0f2fe;
      color: #0369a1;
    }
    
    .timeline-item:not(:last-child)::after {
      content: '';
      position: absolute;
      left: 11px;
      top: 24px;
      bottom: -16px;
      width: 2px;
      background: #e2e8f0;
    }
    
    .comment-box {
      transition: all 0.3s ease;
      border: 1px solid #e2e8f0;
    }
    
    .comment-box:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
    }
    
    .attachment-card:hover {
      border-color: var(--primary);
    }
    
    .animate-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
  </style>
</head>
<body class="flex h-screen overflow-hidden">
  <!-- Sidebar -->
  <aside class="sidebar w-64 flex-shrink-0 flex flex-col">
    <div class="p-6">
      <div class="flex items-center space-x-3">
        <img src="assets/logo.svg" alt="QuickDesk Logo" class="w-8 h-8">
        <span class="text-xl font-bold">QuickDesk</span>
      </div>
    </div>
    
    <nav class="flex-1 px-4 space-y-1">
      <a href="dashboard.html" class="nav-link flex items-center space-x-3 py-3 px-4 rounded-lg">
        <i class="fas fa-tachometer-alt w-5"></i>
        <span>Dashboard</span>
      </a>
      <a href="ticket-create.html" class="nav-link flex items-center space-x-3 py-3 px-4 rounded-lg">
        <i class="fas fa-plus-circle w-5"></i>
        <span>Create Ticket</span>
      </a>
      <a href="admin.html" class="nav-link flex items-center space-x-3 py-3 px-4 rounded-lg">
        <i class="fas fa-users-cog w-5"></i>
        <span>Admin Panel</span>
      </a>
    </nav>
    
    <div class="p-6 border-t border-white border-opacity-10">
      <div class="flex items-center space-x-3">
        <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="User" class="w-10 h-10 rounded-full">
        <div class="flex-1">
          <div class="font-medium">John Doe</div>
          <div class="text-xs text-white text-opacity-70">Admin</div>
        </div>
        <button onclick="logout()" class="text-white text-opacity-70 hover:text-opacity-100">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </div>
  </aside>

  <!-- Main Content -->
  <div class="flex-1 flex flex-col overflow-hidden">
    <!-- Top Navigation -->
    <header class="bg-white shadow-sm">
      <div class="flex items-center justify-between px-6 py-4">
        <div>
          <h1 class="text-xl font-bold text-gray-800 flex items-center">
            <a href="dashboard.html" class="mr-2 text-blue-600 hover:text-blue-800">
              <i class="fas fa-chevron-left"></i>
            </a>
            Ticket Details
          </h1>
        </div>
        <div class="flex items-center space-x-4">
          <button class="relative p-2 text-gray-500 hover:text-gray-700">
            <i class="fas fa-bell"></i>
            <span class="absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></span>
          </button>
        </div>
      </div>
    </header>

    <!-- Main Content Area -->
    <main class="flex-1 overflow-y-auto p-6 bg-gray-50">
      <div class="max-w-6xl mx-auto">
        <!-- Ticket Header -->
        <div class="ticket-card rounded-xl p-6 mb-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between">
            <div class="flex items-center mb-4 md:mb-0">
              <h2 class="text-2xl font-bold text-gray-800 mr-4">#<span id="ticketId">101</span> - <span id="ticketTitle">Cannot login to dashboard</span></h2>
              <span id="ticketStatus" class="badge badge-open mr-2">Open</span>
              <span id="ticketPriority" class="badge badge-high">High</span>
            </div>
            <div class="flex space-x-2">
              <button id="closeTicket" class="px-4 py-2 border border-gray-300 rounded-lg font-medium text-gray-700 hover:bg-gray-50">
                <i class="fas fa-check-circle mr-2"></i> Close Ticket
              </button>
              <button id="editTicket" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                <i class="fas fa-pencil-alt mr-2"></i> Edit
              </button>
            </div>
          </div>
        </div>
        
        <!-- Ticket Body -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
          <!-- Left Column -->
          <div class="lg:col-span-2 space-y-6">
            <!-- Ticket Description -->
            <div class="ticket-card rounded-xl p-6">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">Description</h3>
              <div id="ticketDescription" class="prose max-w-none text-gray-700">
                <p>When attempting to log in to the dashboard, users receive an "Invalid credentials" error even when entering the correct username and password. This issue started occurring after the recent system update.</p>
                <p><strong>Steps to reproduce:</strong></p>
                <ol>
                  <li>Navigate to the login page</li>
                  <li>Enter valid credentials</li>
                  <li>Click "Sign In"</li>
                  <li>Error message appears</li>
                </ol>
                <p><strong>Expected behavior:</strong> User should be logged in and redirected to dashboard.</p>
              </div>
            </div>
            
            <!-- Activity Timeline -->
            <div class="ticket-card rounded-xl p-6">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">Activity Timeline</h3>
              <div class="space-y-4">
                <div class="timeline-item relative pl-8">
                  <div class="absolute left-0 top-0 w-6 h-6 rounded-full bg-blue-100 flex items-center justify-center">
                    <i class="fas fa-plus text-blue-600 text-xs"></i>
                  </div>
                  <div class="text-sm font-medium">Ticket created</div>
                  <div class="text-xs text-gray-500">Today at 9:30 AM by John Doe</div>
                </div>
                <div class="timeline-item relative pl-8">
                  <div class="absolute left-0 top-0 w-6 h-6 rounded-full bg-purple-100 flex items-center justify-center">
                    <i class="fas fa-user-tag text-purple-600 text-xs"></i>
                  </div>
                  <div class="text-sm font-medium">Assigned to Sarah Johnson</div>
                  <div class="text-xs text-gray-500">Today at 10:15 AM by System</div>
                </div>
                <div class="timeline-item relative pl-8">
                  <div class="absolute left-0 top-0 w-6 h-6 rounded-full bg-yellow-100 flex items-center justify-center">
                    <i class="fas fa-comment text-yellow-600 text-xs"></i>
                  </div>
                  <div class="text-sm font-medium">Comment added</div>
                  <div class="text-xs text-gray-500">Today at 11:45 AM by Sarah Johnson</div>
                  <div class="mt-1 text-sm text-gray-700">I'm looking into this issue. Can you confirm if you're using the correct domain?</div>
                </div>
              </div>
            </div>
            
            <!-- Comments Section -->
            <div class="ticket-card rounded-xl p-6">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">Comments</h3>
              <div id="commentsContainer" class="space-y-4 mb-6">
                <!-- Comment 1 -->
                <div class="flex items-start space-x-3">
                  <img src="https://randomuser.me/api/portraits/women/44.jpg" alt="User" class="w-10 h-10 rounded-full">
                  <div class="flex-1">
                    <div class="bg-gray-50 p-4 rounded-lg">
                      <div class="flex items-center justify-between mb-1">
                        <span class="font-medium">Sarah Johnson</span>
                        <span class="text-xs text-gray-500">Today at 11:45 AM</span>
                      </div>
                      <p class="text-gray-700">I'm looking into this issue. Can you confirm if you're using the correct domain?</p>
                    </div>
                  </div>
                </div>
                
                <!-- Comment 2 -->
                <div class="flex items-start space-x-3">
                  <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="User" class="w-10 h-10 rounded-full">
                  <div class="flex-1">
                    <div class="bg-gray-50 p-4 rounded-lg">
                      <div class="flex items-center justify-between mb-1">
                        <span class="font-medium">John Doe</span>
                        <span class="text-xs text-gray-500">Today at 12:30 PM</span>
                      </div>
                      <p class="text-gray-700">Yes, I'm using the correct domain (app.quickdesk.com). The same credentials work on the mobile app but not on web.</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <!-- New Comment Form -->
              <div class="border-t pt-4">
                <div class="flex items-start space-x-3">
                  <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="User" class="w-10 h-10 rounded-full">
                  <div class="flex-1">
                    <form id="commentForm" class="space-y-2">
                      <div class="comment-box rounded-lg p-3 focus:outline-none" contenteditable="true" placeholder="Add a comment..."></div>
                      <div class="flex justify-between items-center">
                        <div class="flex space-x-2">
                          <button type="button" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-paperclip"></i>
                          </button>
                          <button type="button" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-at"></i>
                          </button>
                        </div>
                        <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                          Post Comment
                        </button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Right Column -->
          <div class="space-y-6">
            <!-- Ticket Details -->
            <div class="ticket-card rounded-xl p-6">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">Details</h3>
              <div class="space-y-3">
                <div>
                  <div class="text-xs text-gray-500">Created</div>
                  <div class="text-sm font-medium" id="ticketCreated">Today at 9:30 AM</div>
                </div>
                <div>
                  <div class="text-xs text-gray-500">Created By</div>
                  <div class="text-sm font-medium" id="ticketCreator">John Doe</div>
                </div>
                <div>
                  <div class="text-xs text-gray-500">Assigned To</div>
                  <div class="text-sm font-medium" id="ticketAssignee">Sarah Johnson</div>
                </div>
                <div>
                  <div class="text-xs text-gray-500">Category</div>
                  <div class="text-sm font-medium" id="ticketCategory">Technical Issue</div>
                </div>
                <div>
                  <div class="text-xs text-gray-500">Last Updated</div>
                  <div class="text-sm font-medium" id="ticketUpdated">Today at 12:30 PM</div>
                </div>
              </div>
            </div>
            
            <!-- Attachments -->
            <div class="ticket-card rounded-xl p-6">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">Attachments</h3>
              <div class="space-y-3">
                <a href="#" class="attachment-card flex items-center p-3 border rounded-lg hover:border-blue-500 transition">
                  <div class="bg-blue-100 text-blue-600 p-2 rounded-lg mr-3">
                    <i class="fas fa-file-image"></i>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium truncate">screenshot-error.png</div>
                    <div class="text-xs text-gray-500">2.4 MB</div>
                  </div>
                  <i class="fas fa-download text-gray-400 ml-2"></i>
                </a>
                <a href="#" class="attachment-card flex items-center p-3 border rounded-lg hover:border-blue-500 transition">
                  <div class="bg-blue-100 text-blue-600 p-2 rounded-lg mr-3">
                    <i class="fas fa-file-alt"></i>
                  </div>
                  <div class="flex-1 min-w-0">
                    <div class="text-sm font-medium truncate">error-log.txt</div>
                    <div class="text-xs text-gray-500">0.1 MB</div>
                  </div>
                  <i class="fas fa-download text-gray-400 ml-2"></i>
                </a>
              </div>
              <button class="mt-3 w-full py-2 border border-dashed border-gray-300 rounded-lg text-sm text-gray-500 hover:border-blue-500 hover:text-blue-500 transition">
                <i class="fas fa-plus mr-1"></i> Add Attachment
              </button>
            </div>
            
            <!-- Related Tickets -->
            <div class="ticket-card rounded-xl p-6">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">Related Tickets</h3>
              <div class="space-y-3">
                <a href="#" class="block p-3 hover:bg-gray-50 rounded-lg transition">
                  <div class="text-sm font-medium">#98 - Login page loading slowly</div>
                  <div class="flex items-center mt-1">
                    <span class="badge badge-closed text-xs mr-2">Closed</span>
                    <span class="text-xs text-gray-500">2 days ago</span>
                  </div>
                </a>
                <a href="#" class="block p-3 hover:bg-gray-50 rounded-lg transition">
                  <div class="text-sm font-medium">#87 - Password reset email not sending</div>
                  <div class="flex items-center mt-1">
                    <span class="badge badge-open text-xs mr-2">Open</span>
                    <span class="text-xs text-gray-500">1 week ago</span>
                  </div>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Check authentication
    if (!localStorage.getItem('isAuthenticated')) {
      window.location.href = 'login.html';
    }

    // Initialize WebSocket connection
    const socket = io('http://localhost:5000');
    
    // Get ticket ID from URL
    function getTicketId() {
      const params = new URLSearchParams(window.location.search);
      return params.get('id') || '101';
    }
    
    // DOM Elements
    const ticketIdElement = document.getElementById('ticketId');
    const ticketTitleElement = document.getElementById('ticketTitle');
    const ticketStatusElement = document.getElementById('ticketStatus');
    const ticketPriorityElement = document.getElementById('ticketPriority');
    const ticketDescriptionElement = document.getElementById('ticketDescription');
    const ticketCreatedElement = document.getElementById('ticketCreated');
    const ticketCreatorElement = document.getElementById('ticketCreator');
    const ticketAssigneeElement = document.getElementById('ticketAssignee');
    const ticketCategoryElement = document.getElementById('ticketCategory');
    const ticketUpdatedElement = document.getElementById('ticketUpdated');
    const commentsContainer = document.getElementById('commentsContainer');
    const commentForm = document.getElementById('commentForm');
    const commentInput = commentForm.querySelector('[contenteditable]');
    const closeTicketBtn = document.getElementById('closeTicket');
    const editTicketBtn = document.getElementById('editTicket');
    
    // Current ticket data
    let currentTicket = null;
    
    // Fetch ticket data
    async function fetchTicketData() {
      try {
        // Simulate API call (replace with actual fetch)
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Sample data - replace with actual API response
        const ticketData = {
          id: getTicketId(),
          title: "Cannot login to dashboard",
          status: "Open",
          priority: "High",
          description: `<p>When attempting to log in to the dashboard, users receive an "Invalid credentials" error even when entering the correct username and password. This issue started occurring after the recent system update.</p>
                        <p><strong>Steps to reproduce:</strong></p>
                        <ol>
                          <li>Navigate to the login page</li>
                          <li>Enter valid credentials</li>
                          <li>Click "Sign In"</li>
                          <li>Error message appears</li>
                        </ol>
                        <p><strong>Expected behavior:</strong> User should be logged in and redirected to dashboard.</p>`,
          created: "Today at 9:30 AM",
          creator: "John Doe",
          assignee: "Sarah Johnson",
          category: "Technical Issue",
          updated: "Today at 12:30 PM",
          comments: [
            {
              id: 1,
              user: "Sarah Johnson",
              avatar: "https://randomuser.me/api/portraits/women/44.jpg",
              content: "I'm looking into this issue. Can you confirm if you're using the correct domain?",
              time: "Today at 11:45 AM"
            },
            {
              id: 2,
              user: "John Doe",
              avatar: "https://randomuser.me/api/portraits/men/32.jpg",
              content: "Yes, I'm using the correct domain (app.quickdesk.com). The same credentials work on the mobile app but not on web.",
              time: "Today at 12:30 PM"
            }
          ],
          attachments: [
            { name: "screenshot-error.png", size: "2.4 MB", type: "image" },
            { name: "error-log.txt", size: "0.1 MB", type: "text" }
          ]
        };
        
        currentTicket = ticketData;
        updateTicketUI();
      } catch (error) {
        console.error("Error fetching ticket data:", error);
      }
    }
    
    // Update UI with ticket data
    function updateTicketUI() {
      if (!currentTicket) return;
      
      ticketIdElement.textContent = currentTicket.id;
      ticketTitleElement.textContent = currentTicket.title;
      ticketStatusElement.textContent = currentTicket.status;
      ticketStatusElement.className = `badge ${currentTicket.status === 'Open' ? 'badge-open' : currentTicket.status === 'Closed' ? 'badge-closed' : 'badge-pending'} mr-2`;
      ticketPriorityElement.textContent = currentTicket.priority;
      ticketPriorityElement.className = `badge ${currentTicket.priority === 'High' ? 'badge-high' : currentTicket.priority === 'Medium' ? 'badge-medium' : 'badge-low'}`;
      ticketDescriptionElement.innerHTML = currentTicket.description;
      ticketCreatedElement.textContent = currentTicket.created;
      ticketCreatorElement.textContent = currentTicket.creator;
      ticketAssigneeElement.textContent = currentTicket.assignee;
      ticketCategoryElement.textContent = currentTicket.category;
      ticketUpdatedElement.textContent = currentTicket.updated;
      
      // Update comments
      commentsContainer.innerHTML = currentTicket.comments.map(comment => `
        <div class="flex items-start space-x-3">
          <img src="${comment.avatar}" alt="${comment.user}" class="w-10 h-10 rounded-full">
          <div class="flex-1">
            <div class="bg-gray-50 p-4 rounded-lg">
              <div class="flex items-center justify-between mb-1">
                <span class="font-medium">${comment.user}</span>
                <span class="text-xs text-gray-500">${comment.time}</span>
              </div>
              <p class="text-gray-700">${comment.content}</p>
            </div>
          </div>
        </div>
      `).join('');
    }
    
    // Handle new comment submission
    commentForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const commentText = commentInput.textContent.trim();
      if (!commentText) return;
      
      // Simulate API call
      await new Promise(resolve => setTimeout(resolve, 300));
      
      // Add new comment to UI
      const newComment = {
        id: Date.now(),
        user: "John Doe",
        avatar: "https://randomuser.me/api/portraits/men/32.jpg",
        content: commentText,
        time: "Just now"
      };
      
      currentTicket.comments.push(newComment);
      updateTicketUI();
      
      // Clear comment input
      commentInput.textContent = '';
      
      // Broadcast comment via WebSocket
      socket.emit('new_comment', {
        ticketId: currentTicket.id,
        comment: newComment
      });
    });
    
    // Handle close ticket
    closeTicketBtn.addEventListener('click', async () => {
      if (confirm("Are you sure you want to close this ticket?")) {
        // Simulate API call
        await new Promise(resolve => setTimeout(resolve, 300));
        
        currentTicket.status = "Closed";
        updateTicketUI();
        
        // Broadcast status change via WebSocket
        socket.emit('ticket_status', {
          ticketId: currentTicket.id,
          status: "Closed"
        });
      }
    });
    
    // Handle edit ticket
    editTicketBtn.addEventListener('click', () => {
      window.location.href = `ticket-edit.html?id=${currentTicket.id}`;
    });
    
    // WebSocket event listeners
    socket.on('new_comment', (data) => {
      if (data.ticketId === currentTicket.id) {
        currentTicket.comments.push(data.comment);
        updateTicketUI();
      }
    });
    
    socket.on('ticket_status', (data) => {
      if (data.ticketId === currentTicket.id) {
        currentTicket.status = data.status;
        updateTicketUI();
      }
    });
    
    // Logout function
    function logout() {
      localStorage.removeItem('isAuthenticated');
      window.location.href = 'login.html';
    }
    
    // Initialize
    fetchTicketData();
  </script>
</body>
</html>